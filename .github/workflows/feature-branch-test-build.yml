name: Test build Pull Request

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]


permissions:
  id-token: write   # Required for OIDC auth
  contents: read    # Required to read repo contents
  
env:
  IGNORE_PATTERN: (^README\.md$|^.gitignore|^.vscode/)

jobs:
  test-build:
    name: Test build
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetch full history

      - name: Detect code changes excluding README/docs
        id: check_changes
        run: |
          MERGE_HEAD=${{ github.event.pull_request.head.sha }}
          MERGE_TARGET_BRANCH=${{ github.event.pull_request.base.ref }}
          
          # Get branch point
          MERGE_BRANCH_POINT="$(git merge-base origin/$MERGE_TARGET_BRANCH $MERGE_HEAD)"
          echo "Merge Head: $MERGE_HEAD"
          echo "Branch point: $MERGE_BRANCH_POINT"
          echo "Merge target branch: $MERGE_TARGET_BRANCH"
          
          # Get list of changed files in the PR
          CHANGED_FILES=$(git diff --name-only $MERGE_BRANCH_POINT $MERGE_HEAD)
          echo "Changed Files: "
          echo $CHANGED_FILES
          echo " "
          
          echo "${{ env.IGNORE_PATTERN }}"
          
          # Filter out files to ignore (README.md, docs/**)
          CODE_CHANGED=$(echo "$CHANGED_FILES" | grep -vE '${{ env.IGNORE_PATTERN }}')
          
          # Output whether code changed
          if [ -z "$CODE_CHANGED" ]; then
            echo "No relevant code changes"
            echo "code_changed=false" >> $GITHUB_ENV
          else
            echo "Code changes detected:"
            echo "$CODE_CHANGED"
            echo "code_changed=true" >> $GITHUB_ENV
          fi

      - name: Test-Build
        if: env.code_changed == 'true'
        id: build
        run: |
          npm i
          npm run build
